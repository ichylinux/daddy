#!/usr/bin/env ruby

require 'erb'
require 'rails'

DADDY_HOME = File.dirname(File.dirname(__FILE__))
RAILS_VERSION = '4.0.6'

action = ARGV[0]

if action == 'new'
  APP_NAME = ARGV[1]

  [
    "rails _#{RAILS_VERSION}_ new #{APP_NAME} -d mysql --skip-bundle",
  ].each do |command|
    puts command
    exit 1 unless system(command)
  end

  # Gemfile
  template = File.join(DADDY_HOME, 'templates', 'Gemfile.erb')
  gemfile = File.join(APP_NAME, 'Gemfile')
  File.write(gemfile, ERB.new(File.read(template)).result)

  # routes
  template = File.join(DADDY_HOME, 'templates', 'config', 'routes.rb.erb')
  routes = File.join(APP_NAME, 'config', 'routes.rb')
  File.write(routes, ERB.new(File.read(template)).result)

  [
    "bundle install",
    "bundle exec rake dad:install",
    "bundle exec rake dad:db:config",
    "bundle exec rake dad:db:create",
    "bundle exec rake db:migrate",
    "bundle exec rails g controller welcome index --no-helper --no-assets",
    "echo '<h1>Welcome to #{APP_NAME}</h1>' > #{File.join('app', 'views', 'welcome', 'index.html')}
  ].each do |command|
    puts command
    exit 1 unless system("cd #{APP_NAME} && #{command}")
  end
end
