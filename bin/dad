#!/usr/bin/bash

MITAMAE_VERSION=v1.7.2

function install_mitamae() {
  # you need to have root previlege
  #sudo sed -i "s/\(^Defaults    secure_path = \).*/\1\/sbin:\/bin:\/usr\/sbin:\/usr\/bin:\/usr\/local\/bin/" /etc/sudoers

  sudo yum install -y -q wget

  sudo mkdir -p /var/daddy/tmp
  sudo chown $USER:$USER /var/daddy/tmp
  pushd /var/daddy/tmp
    rm -f mitamae-x86_64-linux.tar.gz
    wget https://github.com/itamae-kitchen/mitamae/releases/download/${MITAMAE_VERSION}/mitamae-x86_64-linux.tar.gz
    tar zxf mitamae-x86_64-linux.tar.gz
    sudo mv mitamae-x86_64-linux /usr/local/bin/mitamae
  popd
}

function setup_dad() {
  if [ -e /usr/local/bin/mitamae ] && [ `/usr/local/bin/mitamae version | sed -e "s/MItamae \(v.*\)/\1/"` = $MITAMAE_VERSION ]; then
    echo -e "\nmitamae $MITAMAE_VERSION found.\ndaddy is ready.\n"
  else
    echo "install mitamae"
    install_mitamae
  fi
}

function setup_environment() {
  setup_dad
  /usr/local/bin/mitamae local "itamae/environments/$1.rb"
}

case $1 in
  'env')
    setup_environment $2
    ;;
  *)
    bundle exec itamae local --ohai itamae/cookbooks/`echo $@ | sed -e "s/\s/\//g"`.rb
    ;;
esac
